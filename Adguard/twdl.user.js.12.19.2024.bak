// ==UserScript==
// @name        Twitter/X(ç½‘é¡µç‰ˆ)è§†é¢‘/åŸå§‹å›¾ç‰‡/gifä¸€é”®ä¸‹è½½.[limbopro]
// @name:ja     Twitter/X (Web ç‰ˆ) ã®ãƒ“ãƒ‡ã‚ª/å†™çœŸ/GIF ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚[limbopro]
// @name:zh-cn  Twitter/X(ç½‘é¡µç‰ˆ)è§†é¢‘/åŸå§‹å›¾ç‰‡/gifä¸€é”®ä¸‹è½½.[limbopro]
// @name:zh-tw  Twitter/X(ç¶²é ç‰ˆ)å½±ç‰‡/åŸå§‹åœ–ç‰‡/gifä¸€éµä¸‹è¼‰.[limbopro]
// @name:en     Twitter/X(web version)videos/4kPhotos/gif download.[limbopro]
// @name:ko     Twitter/X(ì›¹ë²„ì „) ë™ì˜ìƒ/ì‚¬ì§„/gif ì›í´ë¦­ ë‹¤ìš´ë¡œë“œ.[limbopro]
// @name:ru     Twitter/X (Ğ²ĞµĞ±-Ğ²ĞµÑ€ÑĞ¸Ñ) â€” Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ²Ğ¸Ğ´ĞµĞ¾/Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹/Ğ³Ğ¸Ñ„Ğ¾Ğº Ğ² Ğ¾Ğ´Ğ¸Ğ½ ĞºĞ»Ğ¸Ğº.[limbopro]
// @namespace    https://limbopro.com/
// @version      0.1.3.201
// @description Twitter/X(ç½‘é¡µç‰ˆ)è§†é¢‘/å›¾ç‰‡/gifä¸€é”®ä¸‹è½½.[limbopro] / ä¸€é”®ä¸‹è½½æ¨æ–‡4k/åŸå§‹å›¾ç‰‡å¹¶æŒ‰ç”¨æˆ·åè¿›è¡Œä¿å­˜
// @description:zh-cn  Twitter/X(ç½‘é¡µç‰ˆ)è§†é¢‘/å›¾ç‰‡/gifä¸€é”®ä¸‹è½½.[limbopro] / ä¸€é”®ä¸‹è½½æ¨æ–‡4k/åŸå§‹å›¾ç‰‡å¹¶æŒ‰ç”¨æˆ·åè¿›è¡Œä¿å­˜
// @description:ja Twitter/X (Web ç‰ˆ) ã®ãƒ“ãƒ‡ã‚ª/å†™çœŸ/GIF ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚[limbopro] / ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ„ã‚¤ãƒ¼ãƒˆç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ä¿å­˜ã—ã¾ã™
// @description:zh-tw Twitter/X(ç¶²é ç‰ˆ)å½±ç‰‡/åœ–ç‰‡/gifä¸€éµä¸‹è¼‰.[limbopro] / ä¸€éµä¸‹è¼‰æ¨æ–‡4k/åŸå§‹åœ–ç‰‡ä¸¦æŒ‰ä½¿ç”¨è€…åç¨±å„²å­˜
// @description:en Twitter/X(web version)videos/4kPhotos/gif download.[limbopro] / Download tweet original images(4k) with one click and save by username
// @description:ru Twitter/X (Ğ²ĞµĞ±-Ğ²ĞµÑ€ÑĞ¸Ñ) â€” Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ²Ğ¸Ğ´ĞµĞ¾/Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹/Ğ³Ğ¸Ñ„Ğ¾Ğº Ğ² Ğ¾Ğ´Ğ¸Ğ½ ĞºĞ»Ğ¸Ğº.[limbopro] / Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ñ‚Ğ²Ğ¸Ñ‚Ğ¾Ğ² Ğ¾Ğ´Ğ½Ğ¸Ğ¼ Ñ‰ĞµĞ»Ñ‡ĞºĞ¾Ğ¼ Ğ¼Ñ‹ÑˆĞ¸ Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ Ğ¸Ñ… Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ.
// @description:ko Twitter/X(ì›¹ë²„ì „) ë™ì˜ìƒ/ì‚¬ì§„/gif ì›í´ë¦­ ë‹¤ìš´ë¡œë“œ.[limbopro] / í•œ ë²ˆì˜ í´ë¦­ìœ¼ë¡œ íŠ¸ìœ— ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì‚¬ìš©ì ì´ë¦„ìœ¼ë¡œ ì €ì¥
// @author       limbopro
// @license MIT
// @match        https://twitter.com/*
// @match        https://x.com/*
// @match        https://twittervideodownloader.com/*
// @match        https://twittervid.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=twitter.com
// @orginalURL   https://limbopro.com/Adguard/twdl.user.js
// @grant        none
// @downloadURL https://update.greasyfork.org/scripts/478651/TwitterX%28%E7%BD%91%E9%A1%B5%E7%89%88%29%E8%A7%86%E9%A2%91%E5%8E%9F%E5%A7%8B%E5%9B%BE%E7%89%87gif%E4%B8%80%E9%94%AE%E4%B8%8B%E8%BD%BD%5Blimbopro%5D.user.js
// @updateURL https://update.greasyfork.org/scripts/478651/TwitterX%28%E7%BD%91%E9%A1%B5%E7%89%88%29%E8%A7%86%E9%A2%91%E5%8E%9F%E5%A7%8B%E5%9B%BE%E7%89%87gif%E4%B8%80%E9%94%AE%E4%B8%8B%E8%BD%BD%5Blimbopro%5D.meta.js
// ==/UserScript==

/*
@ author: limbopro
@ website: http://limbopro.com/
@ Gmail: service.limbopro.com@gmail.com
@ Github: https://github.com/limbopro
@ X: https://x.com/limboprossr
*/

// å¼•å…¥å…¨å±€ CSS
var twdlcss = "span[id^=\"ezoic-pub-ad-placeholder-\"], .ez-sidebar-wall, span[data-ez-ph-id], .ez-sidebar-wall-ad,.ez-sidebar-wall {display:none !important} button.twdl.download_pics:hover {background-image: linear-gradient(135deg, #f34079 40%, #fc894d); transition: 0.7s;} .atx {display:none;} .house {z-index:114154 !important; max-width:340px; display:flex; flex-direction:row; flex-wrap:wrap; margin-top:5px;}.help{top:80px !important;/*background:teal;*/} .twdl { z-index:114154 !important; line-height:normal; /*font-size:xx-small;*/ font-size:inherit; text-decoration:none; position:sticky; top:5px; /*text-transform:uppercase;*/ padding:6px 12px; color:white; z-index:114154;} .twittervideodownloader { background:linear-gradient(to bottom, #42a5f5 0%, #1e88e5 100%); box-shadow:inset 0 2px 2px #1976d2;} .twittervid {background:linear-gradient(to bottom, #66BB6A 0%, #43A047 100%); box-shadow:inset 0 2px 2px #388E3C;} .download_pics { /*border-radius:5px 0px 0px 5px; */ border:0px;} .greasyfork {cursor:help; right:295px;background:linear-gradient(rgb(62 53 53) 0%, rgb(31 29 29) 100%);box-shadow:rgb(0 0 0) 0px 2px 2px inset;}"
var newstyle = document.createElement('style')
newstyle.id = 'twdlcss'
newstyle.innerHTML = twdlcss
document.querySelector('head').parentNode.insertBefore(newstyle, document.querySelector('head')) // è½½å…¥


var twURL_regex = new RegExp(/^https:\/\/x\.com\/.*?\/status\/\d{10,100}$/gi) // æ­£åˆ™åŒ¹é…å¯¹çš„ Tweet url
function twdl_div(article, downloaderURL, className, textContent) { // article = article[i]
    let a = document.createElement('a')
    article.querySelectorAll('a').forEach((x) => { // è·å– twitter url
        if (x.href.match(twURL_regex)) {
            //// console.log(x.href);
            a.href = downloaderURL + "#" + x.href;
            //// console.log(a.href)
        }
    })

    a.className = className;
    a.target = '_blank';
    a.zIndex = '114154';
    a.textContent = textContent;
    return a;
}

function twdl_url(article) {
    var twdl_Kurl = '';
    var twURL_regex = new RegExp(/^https:\/\/x\.com\/.*?\/status\/\d{10,100}$/gi) // æ­£åˆ™åŒ¹é…å¯¹çš„ Tweet url
    article.querySelectorAll('a').forEach((x) => { // è·å– twitter url
        if (x.href.match(twURL_regex)) {
            twdl_Kurl = x.href
        }
    })
    //// console.log('å½“å‰æ¨æ–‡é“¾æ¥ğŸ”—...' + ' ' + twdl_Kurl)
    return twdl_Kurl;
}

function iftwnopics_innerText() {
    var language = document.querySelector('html').lang; // en/ja/zh/ru/zh-Hant
    var textContent = '';
    switch (language) { //
        case 'zh':
            textContent = "è¯¥æ¨æ–‡å†…å®¹ä¸å­˜åœ¨å›¾ç‰‡!";
            return textContent;
            break;
        case 'zh-Hant':
            textContent = "è©²æ¨æ–‡å…§å®¹ä¸å­˜åœ¨åœ–ç‰‡!";
            return textContent;
            break;
        /*
    case 'ja':
        textContent = "ã“ã®ãƒ„ã‚¤ãƒ¼ãƒˆã«ã¯ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ï¼";
        return textContent;
        break;
        */
        case 'en':
            textContent = "There is no image in this tweet!";
            return textContent;
            break;
        /*
    case 'ru':
        textContent = "Ğ’ ÑÑ‚Ğ¾Ğ¼ Ñ‚Ğ²Ğ¸Ñ‚Ğµ Ğ½ĞµÑ‚ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ!";
        return textContent;
        break;
        */
        default:
            textContent = "There is no image in this tweet!";
            return textContent;
            break;
    }
}


function downloader_innerText(x) { // [LOADER]/[VID]
    // åˆ¤æ–­å½“å‰ç½‘é¡µè¯­è¨€
    var language = document.querySelector('html').lang; // en/ja/zh/ru/zh-Hant
    var textContent = '';

    if (x == '[VID]') {

        switch (language) { //
            case 'zh':
                textContent = "é€šè¿‡" + x + "ä¸‹è½½è§†é¢‘/åŠ¨å›¾";
                return textContent;
                break;
            case 'zh-Hant':
                textContent = "é€é" + x + "ä¸‹è¼‰å½±ç‰‡/å‹•åœ–";
                return textContent;
                break;
            /*
        case 'ja':
            textContent = "ã“ã‚Œã‚‰ã®ãƒ“ãƒ‡ã‚ª/å†™çœŸ/ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’" + x + "çµŒç”±ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„";
            return textContent;
            break;
            */
            case 'en':
                textContent = "Download video/img/gif via " + x;
                return textContent;
                break;
            /*
        case 'ru':
            textContent = "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¸ Ğ²Ğ¸Ğ´ĞµĞ¾/Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ/Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· " + x;
            return textContent;
            break;
            */
            default:
                textContent = "Download video/img/gif via " + x;
                return textContent;
                break;
        }

    } else if (x == '[LOADER]') {

        switch (language) { //
            case 'zh':
                textContent = "é€šè¿‡" + x + "ä¸‹è½½è§†é¢‘";
                return textContent;
                break;
            case 'zh-Hant':
                textContent = "é€é" + x + "ä¸‹è¼‰å½±ç‰‡";
                return textContent;
                break;
            /*
        case 'ja':
            textContent = x + "çµŒç”±ã§ãƒ“ãƒ‡ã‚ªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
            return textContent;
            break;
            */
            case 'en':
                textContent = "Download video via " + x;
                return textContent;
                break;
            /*
        case 'ru':
            textContent = "Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²Ğ¸Ğ´ĞµĞ¾ Ñ‡ĞµÑ€ĞµĞ· " + x;
            return textContent;
            break;
            */
            default:
                textContent = "Download video via " + x;
                return textContent;
                break;
        }
    }

}



function dlpics_innerText() { // [LOADER]/[VID]
    // åˆ¤æ–­å½“å‰ç½‘é¡µè¯­è¨€
    var language = document.querySelector('html').lang; // en/ja/zh/ru/zh-Hant
    var textContent = '';
    switch (language) { //
        case 'zh':
            textContent = "ä¸‹è½½å›¾ç‰‡";
            return textContent;
            break;
        case 'zh-Hant':
            textContent = "ä¸‹è¼‰åœ–ç‰‡";
            return textContent;
            break;
        /*
    case 'ja':
        textContent = "å†™çœŸã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹";
        return textContent;
        break;
        */
        case 'en':
            textContent = 'Download img';
            return textContent;
            break;
        /*
    case 'ru':
        textContent = "Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½ĞºĞ¸";
        return textContent;
        break;
        */
        default:
            textContent = 'Download img';
            return textContent;
            break;
    }
}


function promp_innerText() { // [LOADER]/[VID]
    // åˆ¤æ–­å½“å‰ç½‘é¡µè¯­è¨€
    var language = document.querySelector('html').lang; // en/ja/zh/ru/zh-Hant
    var textContent = '';
    switch (language) { //
        case 'zh':
            textContent = "æ‰‹æœºç«¯ç”¨æˆ·ï¼šå½“æµè§ˆå™¨æç¤ºä¿å­˜/ä¸‹è½½å›¾ç‰‡æ—¶ï¼Œè¯·å°½å¯èƒ½å¿«çš„ç‚¹å‡»ç¡®è®¤æŒ‰é’®!ï¼ˆåœ¨æœ¬æ¬¡ä¼šè¯ä¸­ï¼Œæœ¬ä¿¡æ¯åªä¼šå‡ºç°ä¸¤æ¬¡ï¼Œç´¯è®¡ä¼šå‡ºç°äº”æ¬¡ï¼Œä»¥ä¾¿ä½ å¯ä»¥å¾ˆå¥½çš„äº†è§£å¦‚ä½•æ“ä½œä¸‹è½½å›¾ç‰‡ï¼‰";
            return textContent;
            break;
        case 'zh-Hant':
            textContent = "æ‰‹æ©Ÿç«¯ç”¨æˆ¶ï¼šç•¶ç€è¦½å™¨æç¤ºå„²å­˜/ä¸‹è¼‰åœ–ç‰‡æ™‚ï¼Œè«‹ç›¡å¯èƒ½å¿«çš„é»æ“Šç¢ºèªæŒ‰éˆ•!ï¼ˆåœ¨æœ¬æ¬¡æœƒè©±ä¸­ï¼Œæœ¬è³‡è¨Šåªæœƒå‡ºç¾å…©æ¬¡ï¼Œç´¯è¨ˆæœƒå‡ºç¾äº”æ¬¡ï¼Œä»¥ä¾¿ä½ å¯ä»¥å¾ˆå¥½çš„äº†è§£å¦‚ä½•æ“ä½œä¸‹è¼‰åœ–ç‰‡ï¼‰";
            return textContent;
            break;
        case 'en':
            textContent = 'Mobile users: When the browser prompts you to save/download the image, please click the confirmation button as quickly as possible! (In this session, this message will only appear twice, and it will appear five times in total, so that you can Learn how to download images)';
            return textContent;
            break;
        default:
            textContent = 'Mobile users: When the browser prompts you to save/download the image, please click the confirmation button as quickly as possible! (In this session, this message will only appear twice, and it will appear five times in total, so that you can Learn how to download images)';
            return textContent;
            break;
    }
}

if (localStorage.getItem('clickcount') == '' || localStorage.getItem('clickcount') == null) {
    var twdl_clickCount = 0;
    console.log("twdl_clickCount è®¾ç½® ä¸º " + '0')
} else {
    var twdl_clickCount = localStorage.getItem('clickcount');
    console.log("twdl_clickCount è®¾ç½® ä¸º " + localStorage.getItem('clickcount'))
}

function dlpicsfromURL(imgsrcURL, userName, article) {
    if (imgsrcURL.length == 0) {
        alert(iftwnopics_innerText())
    } else {

        if (navigator.userAgent.toString().toLowerCase().search(/android|iphone|mobile/) !== -1) {
            sessionStorage.setItem('clickcount', twdl_clickCount += 1) // ç‚¹å‡»ä¸‹è½½å›¾ç‰‡æŒ‰é’®æ¬¡æ•°ç»Ÿè®¡
            localStorage.setItem('clickcount', twdl_clickCount) // ç‚¹å‡»ä¸‹è½½å›¾ç‰‡æŒ‰é’®æ¬¡æ•°ç»Ÿè®¡
            if (sessionStorage.getItem('clickcount') < 3 && localStorage.getItem('clickcount') < 5) { // å¦‚æœå·²ç»æç¤ºäº†ä¸¤æ¬¡åˆ™ä¹‹åä¸ä¼šåœ¨åœ¨æœ¬æ¬¡sessionæç¤º
                alert(promp_innerText())
            }
        }

        // Part of the code is modified from CodeingShare
        // https://ww4k.com/CodeingShare/donwload_image_difference_domain.html
        // è§£å†³è·¨åŸŸ Canvas æ±¡æŸ“é—®é¢˜

        var timeloop = 0;

        console.log(imgsrcURL.length + ' length')

        //imgsrcURL.forEach((x, index) => {

        for (var i = 0; i < imgsrcURL.length; i++) {

            console.log("i=" + i + ' atx')

            if (navigator.userAgent.toString().toLowerCase().search(/android|iphone|mobile/) !== -1) { //  å¦‚æœå½“å‰æµè§ˆå™¨ä»£ç†ä¸ºæ‰‹æœºä»£ç†
                timeloop = 1
                console.log('userAgent: Mobile')
            } else if (navigator.userAgent.toString().toLowerCase().search(/chrome/) !== -1) {
                timeloop = 0
                console.log('userAgent: Not Mobile but chrome')
            } else {
                timeloop = 1
                console.log('userAgent: Not Mobile but Safari')
            }

            function timeDelay(i) {

                function dlTime(pic) {
                    var img = new Image() // è®¾ç½®å»¶æ—¶
                    img.src = document.querySelector("[src='" + imgsrcURL[pic] + "']").src
                    var dltime = (Math.ceil(img.width * img.height / 1048576) * 1000)

                    if (dltime == 1000) {
                        dltime = 2000
                    } else {
                        dltime = (dltime * 0.5 + 2000)
                    }

                    if (img.complete) {
                        console.log('å›¾ç‰‡å¤§å°å·²è®¡ç®—ï¼›å›¾ç‰‡å·²é”€æ¯ğŸ…')
                        img = null;
                    }

                    console.log('dltime:' + dltime + 'ms')
                    return dltime
                }

                if (i == 0) {
                    console.log(0 + "ms")
                    return 0;
                } else if (i == 1) {
                    console.log(dlTime(i - 1) + 'ms' + 'åå¼€å§‹ä¸‹è½½ç¬¬' + (i + 1) + "å¼ å›¾ç‰‡")
                    return dlTime(i - 1)
                } else if (i == 2) {
                    console.log((dlTime(i - 1) + dlTime(i - 2)) + 'ms' + 'åå¼€å§‹ä¸‹è½½ç¬¬' + (i + 1) + "å¼ ")
                    return (dlTime(i - 1) + dlTime(i - 2))
                } else {
                    console.log((dlTime(i - 1) + dlTime(i - 2) + dlTime(i - 3)) + 'ms' + 'åå¼€å§‹ä¸‹è½½ç¬¬' + (i + 1) + "å¼ ")
                    return (dlTime(i - 1) + dlTime(i - 2) + dlTime(i - 3))
                }

            }

            (function (index) {
                setTimeout(() => {
                    var image = new Image()
                    image.setAttribute("crossOrigin", "anonymous");
                    image.src = imgsrcURL[index];
                    image.onload = function () {
                        var canvas = document.createElement("canvas");
                        canvas.id = 'twdl'
                        canvas.width = image.width;
                        canvas.height = image.height;
                        var context = canvas.getContext("2d");
                        context.drawImage(image, 0, 0, image.width, image.height);
                        var url = canvas.toDataURL("image/jpeg", 1.0);
                        var a = document.createElement("a");
                        a.download = userName || "photo";
                        a.href = url;
                        // a.textContent = userName + ' '
                        // article.querySelector('div.house').appendChild(a)

                        var event = new MouseEvent("click");
                        event.initEvent('click', true, true);
                        a.dispatchEvent(event);
                        // æ¸…é™¤æ•´ä¸ªCanvas
                        context.clearRect(0, 0, image.width, image.height);
                        canvas.remove()
                        canvas = null;
                        context = null;

                        if (image.complete) {
                            console.log('å›¾ç‰‡å·²ä¸‹è½½ï¼›å›¾ç‰‡å·²é”€æ¯ğŸ…')
                            image = null;
                        }

                    }
                }, timeDelay(i) * timeloop)
            })(i)
        }

        // })

    }
}


function get_imgsURL(article, userName) {
    var url = [];
    var large_regex = new RegExp(/name=.*/ig)
    article.querySelectorAll('a[class=' + userName + ']').forEach((x) => {
        console.log('get_imgsURL -> ' + x)
        console.log('get_imgsURL -> ' + (x.toString().replace(large_regex, 'name=4096x4096')))
        url.push((x.toString().replace(large_regex, 'name=4096x4096'))) // é»˜è®¤ä¸‹è½½æœ€å¤§åŒ–å›¾ç‰‡
    })

    return url;
}

function userName(article) {
    var fileName = '';
    var regex_name = new RegExp(/\/status\/\d{10,100}$/gi) // æ­£åˆ™åŒ¹é…å¯¹çš„ Tweet url
    var twURL_regex = new RegExp(/^https:\/\/x\.com\/.*?\/status\/\d{10,100}$/gi) // æ­£åˆ™åŒ¹é…å¯¹çš„ Tweet url

    article.querySelectorAll('a').forEach((x) => { // è·å– twitter url
        if (x.href.match(twURL_regex)) {
            fileName = x.href.replaceAll('https://x.com/', '').replaceAll(regex_name, '')
        }
    })

    return fileName;
}

async function twdl() {
    if (document.querySelectorAll('[data-testid="cellInnerDiv"]')) {
        var large_regex = new RegExp(/name=.*/ig)
        var article = document.querySelectorAll('[data-testid="cellInnerDiv"]')
        for (let i = 0; i < article.length; i++) { // twittervid

            if (article[i].querySelector('.house') == null && (article[i].querySelector('[data-testid="videoPlayer"]') || article[i].querySelectorAll("img[src*='name=']").length >= 1)) { // å¦‚æœ article[i] ä¸åŒ…å« .house ï¼Œä½† article[i] åŒ…å«å›¾ç‰‡æˆ–è§†é¢‘ï¼Œé‚£ä¹ˆåˆ›å»º .house
                var house = document.createElement('div')
                house.className = 'house'

                var vid = twdl_div(article[i], 'https://twittervid.com/', 'twdl twittervid', downloader_innerText('[VID]'))
                var loader_ = twdl_div(article[i], 'https://twittervideodownloader.com/', 'twdl twittervideodownloader', downloader_innerText('[LOADER]'))
                var help = twdl_div(article[i], 'https://greasyfork.org/zh-CN/scripts/478651-twitter-%E7%BD%91%E9%A1%B5%E7%89%88%E5%A4%9A%E8%A7%86%E9%A2%91-gif%E4%B8%8B%E8%BD%BD-limbopro', 'twdl help', 'Need Help?')

                var downloader = document.createElement('button')
                downloader.className = 'twdl download_pics'
                downloader.innerText = dlpics_innerText()

                article[i].querySelectorAll("img[src*='name=']").forEach((x) => {
                    var a = document.createElement('a')
                    a.href = x.src
                    a.className = "twdl_" + userName(article[i])
                    house.appendChild(a)
                })



                var array = [downloader, vid, loader_, help]

                array.forEach((x) => {
                    house.appendChild(x)
                })


                if (article[i].querySelectorAll("div.css-175oi2r.r-12kyg2d")[0] && article[i].querySelector('[data-testid="videoPlayer"]')) { // æ¨æ–‡å­˜åœ¨æ–‡å­—å›¾ç‰‡ä¸”æœ‰è§†é¢‘çš„æƒ…å†µä¸‹
                    article[i].querySelectorAll("div.css-175oi2r.r-12kyg2d")[0].appendChild(house);

                } else if (article[i].querySelectorAll('[dir=auto][lang]')[0] && article[i].querySelector('[data-testid="videoPlayer"]')) {
                    article[i].querySelectorAll('[dir=auto][lang]')[0].appendChild(house);

                } else if (article[i].querySelector('[data-testid="videoPlayer"]')) { // æ¨æ–‡æ²¡æœ‰æ–‡å­—å›¾ç‰‡ä»…æœ‰è§†é¢‘çš„æƒ…å†µä¸‹
                    article[i].querySelector("[data-testid='videoComponent']").appendChild(house)

                } else if (article[i].querySelectorAll('[dir=auto][lang]')[0] && article[i].querySelectorAll("img[src*='name=']").length >= 1) {
                    article[i].querySelectorAll('[dir=auto][lang]')[0].appendChild(house);

                    article[i].querySelectorAll("img[src*='name=']").forEach((x) => {
                        x.src = x.src.replace(large_regex, 'name=4096x4096')
                    })

                } else if (article[i].querySelectorAll("img[src*='name=']").length >= 1 && article[i].querySelectorAll("img")[1] !== null) {
                    article[i].querySelectorAll("div[aria-labelledby]")[0].parentNode.insertBefore(house, article[i].querySelectorAll("div[aria-labelledby]")[0])
                    article[i].querySelectorAll("img[src*='name=']").forEach((x) => {
                        x.src = x.src.replace(large_regex, 'name=4096x4096')
                    })
                }


                downloader.addEventListener('click', () => {
                    dlpicsfromURL(get_imgsURL(article[i], "twdl_" + userName(article[i])), userName(article[i]), article[i])
                })

            } else {
                // console.log(userName(article[i]) + " " + twdl_url(article[i]) + " å•¥ä¹Ÿæ²¡æœ‰...")
            }
        }

    }
}

window.addEventListener('load', function () {
    console.log('é¡µé¢åŠ è½½æˆåŠŸğŸ…...')
    twdl()
});

window.onpopstate = function (event) {
    twdl()
    console.log("URL has changed!");
}

setInterval(() => {
    var scrollY = window.pageYOffset;
    setTimeout(() => {
        if (scrollY !== window.pageYOffset) {
            twdl()
            console.log('æ»šåŠ¨æ¡åŠ¨äº†...')
        } else {
            console.log('æ»šåŠ¨æ¡æœªåŠ¨...')
        }
    }, 2500)
}, 1500)

function inDownloaderPage() { // è·å–å½“å‰ç½‘é¡µ url -> ç»™ input èµ‹å€¼ -> ç‚¹å‡»ä¸‹è½½æŒ‰é’®

    if (window.location.href.match(/(twittervid\.com)/gi)) {

        if (document.querySelector('#tweetUrl') !== null && document.querySelector('#loadVideos') !== null) {
            document.querySelector('#tweetUrl').value = window.location.href.replace('https://twittervid.com/#', '')
            if (document.querySelector('#tweetUrl').value == 'https://twittervid.com/') {
            } else if (document.querySelector('#tweetUrl').value.match(twURL_regex)) {
                document.querySelector('#loadVideos').click()
            }
        }
    }

    if (window.location.href.match(/(twittervideodownloader\.com)/gi)) {
        if (document.querySelector('#tweetURL') !== null && document.querySelector('#submitBtn') !== null) {
            document.querySelector('#tweetURL').value = window.location.href.replace('https://twittervideodownloader.com/#', '')
            if (document.querySelector('#tweetURL').value == 'https://twittervideodownloader.com/') {
            } else if (document.querySelector('#tweetUrl').value.match(twURL_regex)) {
                document.querySelector('#submitBtn').click()
            }
        }
    }

}

if (window.location.href.match(/(twittervid\.com|twittervideodownloader)/gi) !== null) {
    inDownloaderPage()
}

